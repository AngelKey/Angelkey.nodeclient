// Generated by IcedCoffeeScript 1.6.3-g
(function() {
  var Base, E, EscOk, FN, Infile, Outfile, PasswordManager, ProgressBar, SC, SRV, add_option_dict, base58, constants, crypto, env, fs, iced, join, log, myfs, pick, req, rmkey, triplesec, __iced_k, __iced_k_noop, _ref,
    __slice = [].slice;

  iced = require('iced-coffee-script/lib/coffee-script/iced').runtime;
  __iced_k = __iced_k_noop = function() {};

  log = require('../log');

  PasswordManager = require('../pw').PasswordManager;

  base58 = require('../basex').base58;

  crypto = require('crypto');

  myfs = require('../fs');

  fs = require('fs');

  rmkey = require('../util').rmkey;

  add_option_dict = require('./argparse').add_option_dict;

  _ref = require('../file'), Infile = _ref.Infile, Outfile = _ref.Outfile;

  EscOk = require('iced-error').EscOk;

  E = require('../err').E;

  constants = require('../constants').constants;

  join = require('path').join;

  ProgressBar = require('progress');

  FN = constants.filenames;

  SRV = constants.server;

  SC = constants.security;

  triplesec = require('triplesec');

  req = require('../req');

  env = require('../env').env;

  pick = function() {
    var a, args, _i, _len;
    args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
    for (_i = 0, _len = args.length; _i < _len; _i++) {
      a = args[_i];
      if (a != null) {
        return a;
      }
    }
    return null;
  };

  exports.Base = Base = (function() {
    function Base() {}

    Base.prototype.set_argv = function(a) {
      return this.argv = a;
    };

    Base.OPTS = {
      p: {
        alias: 'passhrase',
        help: 'passphrase used to log into keybase'
      },
      c: {
        alias: 'config',
        help: "a configuration file (" + (join('~', FN.config_dir, FN.config_file)) + ")"
      },
      i: {
        alias: "interactive",
        action: "storeTrue",
        help: "interactive mode"
      },
      d: {
        alias: "debug",
        action: "storeTrue",
        help: "debug mode"
      },
      port: {
        help: 'which port to connect to'
      },
      "no-tls": {
        action: "storeTrue",
        help: "turn off HTTPS/TLS (on by default)"
      },
      "host": {
        help: 'which host to connect to'
      },
      "api-uri-prefix": {
        help: "the API prefix to use (" + SRV.api_uri_prefix + ")"
      }
    };

    Base.prototype.use_config = function() {
      return true;
    };

    Base.prototype.use_session = function() {
      return false;
    };

    Base.prototype.config_opts = function() {
      return {};
    };

    Base.prototype.make_outfile = function(cb) {
      var err, file, ___iced_passed_deferral, __iced_deferrals, __iced_k,
        _this = this;
      __iced_k = __iced_k_noop;
      ___iced_passed_deferral = iced.findDeferral(arguments);
      (function(__iced_k) {
        __iced_deferrals = new iced.Deferrals(__iced_k, {
          parent: ___iced_passed_deferral,
          filename: "src/command/base.iced",
          funcname: "Base.make_outfile"
        });
        Outfile.open({
          target: _this.output_filename()
        }, __iced_deferrals.defer({
          assign_fn: (function() {
            return function() {
              err = arguments[0];
              return file = arguments[1];
            };
          })(),
          lineno: 77
        }));
        __iced_deferrals._fulfill();
      })(function() {
        return cb(err, file);
      });
    };

    Base.prototype.init2 = function(_arg, cb) {
      var enc, esc, infile, new_key, outfile, ___iced_passed_deferral, __iced_deferrals, __iced_k,
        _this = this;
      __iced_k = __iced_k_noop;
      ___iced_passed_deferral = iced.findDeferral(arguments);
      infile = _arg.infile, outfile = _arg.outfile, enc = _arg.enc;
      esc = new EscOk(cb);
      (function(__iced_k) {
        __iced_deferrals = new iced.Deferrals(__iced_k, {
          parent: ___iced_passed_deferral,
          filename: "src/command/base.iced",
          funcname: "Base.init2"
        });
        _this.init(esc.check_ok(__iced_deferrals.defer({
          lineno: 84
        }), E.InitError));
        __iced_deferrals._fulfill();
      })(function() {
        (function(__iced_k) {
          if (infile) {
            _this.infn = _this.argv.file[0];
            (function(__iced_k) {
              __iced_deferrals = new iced.Deferrals(__iced_k, {
                parent: ___iced_passed_deferral,
                filename: "src/command/base.iced",
                funcname: "Base.init2"
              });
              Infile.open(_this.infn, esc.check_err(__iced_deferrals.defer({
                assign_fn: (function(__slot_1) {
                  return function() {
                    return __slot_1.infile = arguments[0];
                  };
                })(_this),
                lineno: 87
              })));
              __iced_deferrals._fulfill();
            })(__iced_k);
          } else {
            return __iced_k();
          }
        })(function() {
          (function(__iced_k) {
            if (outfile) {
              (function(__iced_k) {
                __iced_deferrals = new iced.Deferrals(__iced_k, {
                  parent: ___iced_passed_deferral,
                  filename: "src/command/base.iced",
                  funcname: "Base.init2"
                });
                _this.make_outfile(esc.check_err(__iced_deferrals.defer({
                  assign_fn: (function(__slot_1) {
                    return function() {
                      return __slot_1.outfile = arguments[0];
                    };
                  })(_this),
                  lineno: 89
                })));
                __iced_deferrals._fulfill();
              })(__iced_k);
            } else {
              return __iced_k();
            }
          })(function() {
            (function(__iced_k) {
              if (enc && (_this.crypto_mode() !== constants.crypto_mode.NONE)) {
                new_key = _this.crypto_mode() === constants.crypto_mode.ENC;
                (function(__iced_k) {
                  __iced_deferrals = new iced.Deferrals(__iced_k, {
                    parent: ___iced_passed_deferral,
                    filename: "src/command/base.iced",
                    funcname: "Base.init2"
                  });
                  _this.pwmgr.derive_keys(new_key, esc.check_non_null(__iced_deferrals.defer({
                    assign_fn: (function(__slot_1) {
                      return function() {
                        return __slot_1.keys = arguments[0];
                      };
                    })(_this),
                    lineno: 92
                  })));
                  __iced_deferrals._fulfill();
                })(__iced_k);
              } else {
                return __iced_k();
              }
            })(function() {
              _this.eng = _this.make_eng({
                keys: _this.keys,
                infile: _this.infile,
                outfile: _this.outfile
              });
              return cb(true);
            });
          });
        });
      });
    };

    Base.prototype._gen_pwh = function(_arg, cb) {
      var bar, err, extra_keymaterial, km, passphrase, prev, progress_hook, salt, ___iced_passed_deferral, __iced_deferrals, __iced_k,
        _this = this;
      __iced_k = __iced_k_noop;
      ___iced_passed_deferral = iced.findDeferral(arguments);
      passphrase = _arg.passphrase, salt = _arg.salt;
      this.enc = new triplesec.Encryptor({
        key: new Buffer(passphrase, 'utf8'),
        verion: SC.triplesec.version
      });
      bar = null;
      prev = 0;
      progress_hook = function(obj) {
        if (obj.what !== "scrypt") {

        } else {
          bar || (bar = new ProgressBar("- run scrypt [:bar] :percent", {
            width: 35,
            total: obj.total
          }));
          bar.tick(obj.i - prev);
          return prev = obj.i;
        }
      };
      extra_keymaterial = SC.pwh.derived_key_bytes + SC.openpgp.derived_key_bytes;
      (function(__iced_k) {
        __iced_deferrals = new iced.Deferrals(__iced_k, {
          parent: ___iced_passed_deferral,
          filename: "src/command/base.iced",
          funcname: "Base._gen_pwh"
        });
        _this.enc.resalt({
          salt: salt,
          extra_keymaterial: extra_keymaterial,
          progress_hook: progress_hook
        }, __iced_deferrals.defer({
          assign_fn: (function() {
            return function() {
              err = arguments[0];
              return km = arguments[1];
            };
          })(),
          lineno: 121
        }));
        __iced_deferrals._fulfill();
      })(function() {
        if (typeof err === "undefined" || err === null) {
          _this.salt = _this.enc.salt.to_hex();
          _this.pwh = km.extra.slice(0, SC.pwh.derived_key_bytes).toString('hex');
        }
        return cb(err, _this.pwh, _this.salt);
      });
    };

    Base.prototype._login = function(cb) {
      var err, ok, ___iced_passed_deferral, __iced_deferrals, __iced_k,
        _this = this;
      __iced_k = __iced_k_noop;
      ___iced_passed_deferral = iced.findDeferral(arguments);
      ok = false;
      err = null;
      (function(__iced_k) {
        __iced_deferrals = new iced.Deferrals(__iced_k, {
          parent: ___iced_passed_deferral,
          filename: "src/command/base.iced",
          funcname: "Base._login"
        });
        _this._session_check(__iced_deferrals.defer({
          assign_fn: (function() {
            return function() {
              err = arguments[0];
              return ok = arguments[1];
            };
          })(),
          lineno: 133
        }));
        __iced_deferrals._fulfill();
      })(function() {
        (function(__iced_k) {
          var _results, _while;
          _results = [];
          _while = function(__iced_k) {
            var _break, _continue, _next;
            _break = function() {
              return __iced_k(_results);
            };
            _continue = function() {
              return iced.trampoline(function() {
                return _while(__iced_k);
              });
            };
            _next = function(__iced_next_arg) {
              _results.push(__iced_next_arg);
              return _continue();
            };
            if (!!ok) {
              return _break();
            } else {
              (function(__iced_k) {
                __iced_deferrals = new iced.Deferrals(__iced_k, {
                  parent: ___iced_passed_deferral,
                  filename: "src/command/base.iced",
                  funcname: "Base._login"
                });
                _this._login_iter(__iced_deferrals.defer({
                  assign_fn: (function() {
                    return function() {
                      err = arguments[0];
                      return ok = arguments[1];
                    };
                  })(),
                  lineno: 135
                }));
                __iced_deferrals._fulfill();
              })(_next);
            }
          };
          _while(__iced_k);
        })(function() {
          return cb(err, ok);
        });
      });
    };

    Base.prototype._init_pwmgr = function() {
      var pwopts;
      pwopts = {
        password: this.password(),
        salt: this.salt_or_email(),
        interactive: this.argv.interactive
      };
      return this.pwmgr.init(pwopts);
    };

    Base.prototype.password = function() {
      return pick(this.argv.password, this.config.password());
    };

    return Base;

  })();

}).call(this);
