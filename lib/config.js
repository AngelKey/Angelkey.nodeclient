// Generated by IcedCoffeeScript 1.6.3-g
(function() {
  var Config, fs, iced, log, mkdirp, path, util, __iced_k, __iced_k_noop;

  iced = require('iced-coffee-script/lib/coffee-script/iced').runtime;
  __iced_k = __iced_k_noop = function() {};

  path = require('path');

  fs = require('fs');

  log = require('./log');

  util = require('util');

  mkdirp = require('mkdirp');

  exports.Config = Config = (function() {
    function Config(filename, opts) {
      this.filename = filename;
      this.opts = opts;
      this.json = null;
      this.loaded = false;
      this.cache = {};
      this.changed = false;
    }

    Config.prototype.open = function(cb) {
      var err, ___iced_passed_deferral, __iced_deferrals, __iced_k,
        _this = this;
      __iced_k = __iced_k_noop;
      ___iced_passed_deferral = iced.findDeferral(arguments);
      err = null;
      (function(__iced_k) {
        __iced_deferrals = new iced.Deferrals(__iced_k, {
          parent: ___iced_passed_deferral,
          filename: "src/config.iced",
          funcname: "Config.open"
        });
        fs.exists(_this.filename, __iced_deferrals.defer({
          assign_fn: (function(__slot_1) {
            return function() {
              return __slot_1.found = arguments[0];
            };
          })(_this),
          lineno: 23
        }));
        __iced_deferrals._fulfill();
      })(function() {
        (function(__iced_k) {
          if (_this.found) {
            (function(__iced_k) {
              __iced_deferrals = new iced.Deferrals(__iced_k, {
                parent: ___iced_passed_deferral,
                filename: "src/config.iced",
                funcname: "Config.open"
              });
              _this.load(__iced_deferrals.defer({
                assign_fn: (function() {
                  return function() {
                    return err = arguments[0];
                  };
                })(),
                lineno: 25
              }));
              __iced_deferrals._fulfill();
            })(__iced_k);
          } else {
            return __iced_k(!_this.opts.in_config ? (log.warn("No config file found; tried '" + _this.filename + "'"), log.warn("Run 'keybase config' to make a new config file")) : void 0);
          }
        })(function() {
          return cb(err);
        });
      });
    };

    Config.prototype.is_empty = function() {
      return !(this.json != null);
    };

    Config.prototype.is_dirty = function() {
      return this.changed;
    };

    Config.prototype.write = function(cb) {
      var d, dat, err, n, ___iced_passed_deferral, __iced_deferrals, __iced_k,
        _this = this;
      __iced_k = __iced_k_noop;
      ___iced_passed_deferral = iced.findDeferral(arguments);
      err = null;
      (function(__iced_k) {
        if (_this.changed) {
          dat = JSON.stringify(_this.json, null, "    ");
          d = path.dirname(_this.filename);
          (function(__iced_k) {
            __iced_deferrals = new iced.Deferrals(__iced_k, {
              parent: ___iced_passed_deferral,
              filename: "src/config.iced",
              funcname: "Config.write"
            });
            mkdirp(path.dirname(_this.filename), 0x1c0, __iced_deferrals.defer({
              assign_fn: (function() {
                return function() {
                  err = arguments[0];
                  return n = arguments[1];
                };
              })(),
              lineno: 43
            }));
            __iced_deferrals._fulfill();
          })(function() {
            (function(__iced_k) {
              if (err != null) {
                return __iced_k(log.error("Error creating directory '" + d + "': " + err.message));
              } else {
                if (n > 0) {
                  log.warn("Created directory " + d);
                }
                (function(__iced_k) {
                  __iced_deferrals = new iced.Deferrals(__iced_k, {
                    parent: ___iced_passed_deferral,
                    filename: "src/config.iced",
                    funcname: "Config.write"
                  });
                  fs.writeFile(_this.filename, dat, {
                    mode: 0x180
                  }, __iced_deferrals.defer({
                    assign_fn: (function() {
                      return function() {
                        return err = arguments[0];
                      };
                    })(),
                    lineno: 49
                  }));
                  __iced_deferrals._fulfill();
                })(function() {
                  return __iced_k(err != null ? log.error("Error writing to " + _this.filename + ": " + err) : void 0);
                });
              }
            })(__iced_k);
          });
        } else {
          return __iced_k();
        }
      })(function() {
        return cb(err);
      });
    };

    Config.prototype.get = function(key) {
      var p, parts, v, _i, _len;
      parts = key.split(".");
      v = this.json;
      for (_i = 0, _len = parts.length; _i < _len; _i++) {
        p = parts[_i];
        if (v != null) {
          v = v[p];
        }
      }
      return v;
    };

    Config.prototype.set = function(key, val) {
      var d, e, last, p, parts, _i, _len, _ref;
      parts = key.split(".");
      if (this.json == null) {
        this.json = {};
        this.changed = true;
      }
      d = this.json;
      _ref = parts.slice(0, parts.length - 1);
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        p = _ref[_i];
        if (d[p] == null) {
          d[p] = {};
          d = d[p];
          this.changed = true;
        }
      }
      last = parts.slice(-1)[0];
      e = d[last];
      if (e !== val) {
        d[last] = val;
        return this.changed = true;
      }
    };

    Config.prototype.load = function(cb) {
      var e, err, file, key, ___iced_passed_deferral, __iced_deferrals, __iced_k,
        _this = this;
      __iced_k = __iced_k_noop;
      ___iced_passed_deferral = iced.findDeferral(arguments);
      err = null;
      (function(__iced_k) {
        __iced_deferrals = new iced.Deferrals(__iced_k, {
          parent: ___iced_passed_deferral,
          filename: "src/config.iced",
          funcname: "Config.load"
        });
        fs.readFile(_this.filename, __iced_deferrals.defer({
          assign_fn: (function() {
            return function() {
              err = arguments[0];
              return file = arguments[1];
            };
          })(),
          lineno: 85
        }));
        __iced_deferrals._fulfill();
      })(function() {
        var _i, _len, _ref, _ref1;
        if (err != null) {
          log.error("Cannot read file " + _this.filename + ": " + err);
        } else {
          try {
            _this.json = JSON.parse(file);
          } catch (_error) {
            e = _error;
            log.error("Invalid json in " + _this.filename + ": " + e);
            err = e;
          }
        }
        if (err == null) {
          _ref = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            key = _ref[_i];
            if (((_ref1 = _this.json) != null ? _ref1[key] : void 0) == null) {
              log.error("Missing JSON component '" + key + "' in " + _this.filename);
              err = new E.ConfigError("missing component '" + key + "'");
            }
          }
        }
        return cb(err);
      });
    };

    Config.prototype.tmpdir = function() {
      var _ref, _ref1, _ref2;
      if (this._tmpdir == null) {
        this._tmpdir = ((_ref = this.config) != null ? (_ref1 = _ref.json) != null ? (_ref2 = _ref1.files) != null ? _ref2.dir : void 0 : void 0 : void 0) || (path.join(path.sep, "tmp", "mkb"));
      }
      return this._tmpdir;
    };

    Config.prototype._get_file = function(which) {
      var f, _ref, _ref1, _ref2;
      if ((f = this.cache[which]) == null) {
        f = ((_ref = this.config) != null ? (_ref1 = _ref.json) != null ? (_ref2 = _ref1.files) != null ? _ref2[which] : void 0 : void 0 : void 0) || path.join(this.tmpdir(), "keybase." + which);
        this.cache[which] = f;
      }
      return f;
    };

    Config.prototype.sockfile = function() {
      return this._get_file("sock");
    };

    Config.prototype.pidfile = function() {
      return this._get_file("pid");
    };

    Config.prototype.logfile = function() {
      return this._get_file("log");
    };

    Config.prototype.pidfile = function(cb) {
      var _ref, _ref1, _ref2;
      if (this._pidfile == null) {
        this._pidfile = ((_ref = this.config) != null ? (_ref1 = _ref.json) != null ? (_ref2 = _ref1.files) != null ? _ref2.pid : void 0 : void 0 : void 0) || (path.join(this.tmpdir(), "keybase.pid"));
      }
      return this._pidfile;
    };

    Config.prototype.make_tmpdir = function(cb) {
      var err, n, ___iced_passed_deferral, __iced_deferrals, __iced_k,
        _this = this;
      __iced_k = __iced_k_noop;
      ___iced_passed_deferral = iced.findDeferral(arguments);
      n = this.tmpdir();
      (function(__iced_k) {
        __iced_deferrals = new iced.Deferrals(__iced_k, {
          parent: ___iced_passed_deferral,
          filename: "src/config.iced",
          funcname: "Config.make_tmpdir"
        });
        mkdirp(n, __iced_deferrals.defer({
          assign_fn: (function() {
            return function() {
              return err = arguments[0];
            };
          })(),
          lineno: 133
        }));
        __iced_deferrals._fulfill();
      })(function() {
        if (typeof err !== "undefined" && err !== null) {
          log.error("Error making temp dir " + n + ": " + err);
        }
        return cb(typeof err === "undefined" || err === null);
      });
    };

    Config.prototype.file_extension = function() {
      return this.json.file_extension || "kbs";
    };

    Config.prototype.obj = function() {
      return this.json;
    };

    Config.prototype.email = function() {
      return this.json.email;
    };

    Config.prototype.salt = function() {
      return this.json.salt;
    };

    Config.prototype.password = function() {
      return this.json.password;
    };

    return Config;

  })();

}).call(this);
